# 实现说明文档

## 项目概述

本项目实现了基于STM32F108T6的完整OTA固件更新系统，支持通过二维码扫描获取固件URL并完成自动升级。

## 关键实现细节

### 1. Flash分区布局

```
0x08000000 - 0x08001FFF: Bootloader (8KB)
0x08002000 - 0x08008FFF: App A 分区 (28KB)
0x08009000 - 0x0800FFFF: App B 分区 (28KB)
```

每个分区末尾存储分区信息结构（partition_info_t），包含：
- 魔数（用于验证）
- 版本号
- CRC32校验值
- 固件大小
- 分区状态（有效/无效）

### 2. Bootloader工作流程

1. 系统上电后，Bootloader首先运行
2. 检查是否需要进入Bootloader模式（GPIO/UART命令/Flash标志）
3. 如果不需要，验证A/B分区并选择有效分区启动
4. 如果两个分区都有效，选择版本更高的
5. 如果当前分区无效，自动回滚到另一个分区
6. 跳转到选定的应用程序

### 3. OTA升级流程

1. **扫描二维码**：通过UART或摄像头获取二维码数据，解析出固件URL
2. **下载固件**：通过HTTP协议下载固件到RAM缓冲区
3. **版本检查**：提取目标固件版本，与当前版本比较
4. **完整性校验**：计算CRC32，与固件中的CRC32值比较
5. **写入Flash**：
   - 标记当前分区为无效
   - 擦除目标分区
   - 写入新固件
   - 写入分区信息
   - 验证写入的数据
6. **重启设备**：系统重启，Bootloader自动加载新固件

### 4. 异常处理机制

- **下载失败**：显示错误信息，保持当前固件运行
- **校验失败**：不写入Flash，提示用户重试
- **Flash写入失败**：标记目标分区为无效，保持当前分区运行
- **启动失败**：Bootloader检测到新分区无效，自动回滚到旧分区

### 5. 版本控制

固件版本格式：`major.minor.revision.build`（各占1字节）

版本比较规则：
- 先比较主版本号
- 再比较次版本号
- 再比较修订版本号
- 最后比较构建号

只有目标版本大于当前版本时才进行升级。

## 需要集成的外部库

### 1. 二维码解码库

推荐使用以下库之一：
- **QRCodeReader**：轻量级，适合嵌入式系统
- **ZXing**：功能强大，但体积较大
- **quirc**：C语言实现，适合STM32

集成方法：
1. 将库源码添加到项目中
2. 在`qr_scanner.c`中调用库的API
3. 配置UART或摄像头接口

### 2. 网络协议栈

推荐使用：
- **lwIP**：轻量级TCP/IP协议栈
- **mbedTLS**：用于HTTPS支持（可选）

集成方法：
1. 配置lwIP（如果使用以太网）
2. 或使用AT命令通过WiFi模块（如ESP8266/ESP32）
3. 在`firmware_download.c`中实现HTTP客户端

### 3. CRC32和MD5库

- **CRC32**：已在`firmware_download.c`中实现基础版本
- **MD5**：可使用mbedTLS或wolfSSL库

## 硬件接口配置

### UART配置
- **UART1**：用于二维码扫描数据接收
- **UART2**：用于调试输出（可选）

### GPIO配置
- **BOOT0引脚**：用于强制进入Bootloader模式
- **LED引脚**：用于状态指示
- **按键引脚**：用于触发OTA升级（可选）

### Flash配置
- 使用STM32内部Flash
- 需要实现Flash擦写函数（基于HAL库）

## 编译和烧录

### 1. 编译Bootloader

```bash
cd bootloader
make clean
make
```

### 2. 编译应用程序

```bash
cd application
make clean
make
```

### 3. 烧录顺序

1. 先烧录Bootloader到0x08000000
2. 再烧录应用程序到App A分区（0x08002000）

### 4. 固件格式

固件文件需要包含：
- 向量表（位于文件开头）
- 版本信息（位于偏移0x200）
- 应用程序代码
- CRC32校验值（可选，位于文件末尾）

## 测试建议

1. **功能测试**：
   - 测试二维码扫描功能
   - 测试固件下载功能
   - 测试Flash写入功能
   - 测试版本控制功能

2. **异常测试**：
   - 模拟下载失败
   - 模拟校验失败
   - 模拟Flash写入失败
   - 测试回滚机制

3. **压力测试**：
   - 多次连续升级
   - 大文件下载
   - 网络不稳定情况

## 注意事项

1. **RAM限制**：STM32F108T6只有20KB RAM，固件缓冲区需要根据实际情况调整
2. **Flash寿命**：频繁擦写会缩短Flash寿命，建议限制升级频率
3. **电源管理**：升级过程中确保电源稳定
4. **网络稳定性**：建议在网络稳定时进行升级
5. **版本兼容性**：确保新固件与硬件兼容

## 扩展功能建议

1. **断点续传**：支持下载中断后继续下载
2. **差分升级**：只下载差异部分，减少下载时间
3. **加密传输**：使用HTTPS保护固件传输
4. **签名验证**：使用数字签名验证固件来源
5. **远程升级**：支持通过服务器推送升级

